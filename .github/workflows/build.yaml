name: build

on:
  push:

jobs:
  build_tf_a:
    runs-on: ubuntu-20.04
    container: sigmaris/aarch64-linux-crossbuilder:latest
    env:
      WORKDIR: "${{ github.workspace }}/work"
    steps:
      - name: Check out source code
        uses: actions/checkout@v2
      
      - name: Create working directory
        run: mkdir "$WORKDIR"
      
      - name: Clone TF-A
        run: scripts/clone_tfa.sh
      
      - name: Build TF-A
        id: build_tfa
        run: scripts/build_tfa.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v2
        with:
          name: bl31
          path: ${{ steps.build_tfa.outputs.bl31 }}

  build_u_boot:
    runs-on: ubuntu-20.04
    container: sigmaris/aarch64-linux-crossbuilder:latest
    env:
      WORKDIR: "${{ github.workspace }}/work"
    needs: build_tf_a
    steps:
      - name: Check out source code
        uses: actions/checkout@v2
      
      - name: Create working directory
        run: mkdir "$WORKDIR"

      - name: Download TF-A bl31.elf
        uses: actions/download-artifact@v2
        with:
          name: bl31
          path: "${{ github.workspace }}/work"

      - name: Clone U-Boot
        run: scripts/clone_uboot.sh
      
      - name: Build U-Boot
        id: build_uboot
        env:
          BL31: "${{ github.workspace }}/work/bl31.elf"
        run: scripts/build_uboot.sh
